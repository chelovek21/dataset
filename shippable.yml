language: none

env:
  global:
    - DOCKER_ACC=analysiscenter1
    - DOCKER_REPO=ds-py3
    - TAG="latest"

build:
  pre_ci_boot:
    image_name: $DOCKER_ACC/$DOCKER_REPO
    image_tag: $TAG
    pull: false
  pre_ci:
    docker pull $DOCKER_ACC/$DOCKER_REPO:$TAG
  ci:
    - >
      pip3 install sphinx &&
      git checkout --orphan gh-pages &&
      rm -rf * &&
      git checkout master dataset docs &&
      cd docs &&
      make html &&
      cd .. &&
      mv docs/_build/html/* . &&
      rm -rf docs dataset &&
      touch .nojekyll &&
      echo "language: none" > shippable.yml &&
      git add -A . &&
      git commit -am "Build docs" &&
      git remote add gh_push git@github.com:$REPO_FULL_NAME &&
      ssh-agent bash -c 'ssh-add /tmp/ssh/${REPO_NAME}key; git push -f gh_push gh-pages'

integrations:
  hub:
    - integrationName: DockerHub analysiscenter.ru
      type: docker

  notifications:
    - integrationName: Slack analysiscenter.ru
      type: slack
      recipients:
        - "#commits"
      on_success: always
      on_failure: always

  key:
    - integrationName: dataset_key
      type: sshKey
